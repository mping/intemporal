{"version":3,"sources":["intemporal/workflow.cljc"],"mappings":"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","names":["var_args","G__44755","intemporal.workflow/start-worker!","js/Error","store","intemporal.workflow.start_worker_BANG_","cljs.core/constantly","worker-protos","promesa.core/vthread-call","p1__44753#","task-ready?","cljs.core._EQ_","env","intemporal.workflow.internal/*env*","intemporal.store/watch-tasks","_","temp__5804__auto__","map__44757","cljs.core/--destructure-map","cljs.core.get","type","id","task","intemporal.store/dequeue-task","map__44758","last-root","protos","*env*-orig-val__44759","intemporal.workflow/*env*","*env*-temp-val__44760","cljs.core.merge","intemporal.workflow/default-env","or__5045__auto__","intemporal.workflow.internal/resume-task","p__44762","map__44763","intemporal.workflow/enqueue-and-wait","opts","intemporal.workflow.internal/enqueue-and-wait","intemporal.workflow/add-compensation","thunk","cljs.core/ifn?","cljs.core.swap_BANG_","cljs.core/conj","intemporal.workflow/compensate","thunks","cljs.core/deref","seq__44764","cljs.core/seq","chunk__44765","count__44766","i__44767","cljs.core/chunked-seq?","c__5568__auto__","cljs.core/chunk-first","cljs.core/chunk-rest","cljs.core/count","cljs.core/first","cljs.core/next","f"],"sourcesContent":["(ns intemporal.workflow\n  (:require [intemporal.store :as store]\n            [intemporal.workflow.internal :as internal]\n            [promesa.core :as promesa])\n  #?(:cljs (:require-macros\n             [intemporal.workflow.internal :refer [with-env-internal]]\n             [intemporal.workflow :refer [with-env]])))\n\n#?(:clj (set! *warn-on-reflection* true))\n\n;;;;\n;; runtime\n\n(defmacro with-env [m & body]\n  (with-env-internal m body))\n\n;;;;\n;; worker\n\n(defn start-worker!\n  \"Starts a worker thread.\"\n  ([store]\n   (start-worker! store (constantly false)))\n  ([store worker-protos]\n   (promesa/vthread\n     (let [task-ready? #(= :new (:state %))\n           env internal/*env*]\n       (store/watch-tasks store\n                          task-ready?\n                          (fn [_]\n                            ;; the store should handle dequeing atomically\n                            (when-let [{:keys [type id] :as task} (store/dequeue-task store)]\n                              (let [{last-root :root protos :protos} env]\n                                ;; run in a new thread to avoid deadlocks\n                                (promesa/vthread\n                                  (with-env {:store store\n                                             :type  type\n                                             :ref   id\n                                             :root  (or last-root id)\n                                             :protos (or protos worker-protos)}\n                                    (internal/resume-task store worker-protos task)))))))))))\n\n(defn enqueue-and-wait\n  [{:keys [store] :as opts} task]\n  (internal/enqueue-and-wait opts task))\n\n(defn add-compensation\n  \"Adds a compensation action to the current workflow.\"\n  [thunk]\n  (assert (ifn? thunk) \"Compensation action should implement IFn\")\n  (swap! (:compensations internal/*env*) conj thunk))\n\n(defn compensate\n  \"Runs compensation in program order. A failure of the compensation action will stop running other compensations.\"\n  []\n  (let [thunks (-> internal/*env* :compensations deref)]\n    (doseq [f thunks]\n      (f))))"]}